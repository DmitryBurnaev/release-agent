#!/bin/sh
set -e

export WORKING_DIR=/opt/release-agent/

echo "=== reading $(pwd)/.version file ==="
export $(cat .version | grep -v ^# | xargs)

echo "=== pulling image '${DOCKER_IMAGE}' ==="
docker pull ${DOCKER_IMAGE}

echo "=== restarting service ==="
sudo systemctl restart release-agent.service

echo "=== clearing ==="
echo y | docker image prune -a

echo "=== check status ==="
echo "sleeping a while ... "
sleep 5
sudo systemctl show -p ActiveState --value release-agent

echo "=== show containers ==="
sleep 15
docker ps --format "table {{.ID}}\t{{.Image}}\t{{.Names}}\t{{.Status}}\t|" | grep release-agent
echo "==="
